<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libra Energia - Dashboard de ProspecÃ§Ã£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .primary-600 { color: #2563eb; }
        .primary-100 { background-color: #dbeafe; }
        .success-600 { color: #16a34a; }
        .success-100 { background-color: #dcfce7; }
        .warning-600 { color: #ea580c; }
        .warning-100 { background-color: #fed7aa; }
        .bg-primary-600 { background-color: #2563eb; }
        .bg-primary-700 { background-color: #1d4ed8; }
        .bg-success-100 { background-color: #dcfce7; }
        .bg-warning-100 { background-color: #fed7aa; }
        .bg-red-100 { background-color: #fee2e2; }
        .text-success-800 { color: #166534; }
        .text-warning-800 { color: #9a3412; }
        .text-red-800 { color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-primary-600 rounded-lg mr-3 flex items-center justify-center">
                        <span class="text-white font-bold text-xl">âš¡</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        Libra Energia - Dashboard de ProspecÃ§Ã£o
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <span class="mr-2">ðŸ”„</span>
                        Atualizar
                    </button>
                    <button onclick="loadRealData()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                        <span class="mr-2">ðŸ“Š</span>
                        Carregar Dados Reais
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status dos Dados -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-600" id="data-status">Carregando dados...</span>
                </div>
                <div class="text-sm text-gray-500" id="last-update"></div>
            </div>
        </div>

        <!-- MÃ©tricas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-primary-100 rounded-lg">
                        <span class="text-2xl">ðŸ‘¥</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total de Leads</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-leads">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-success-100 rounded-lg">
                        <span class="text-2xl">ðŸŽ¯</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Leads Qualificados</p>
                        <p class="text-2xl font-bold text-gray-900" id="leads-qualificados">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-warning-100 rounded-lg">
                        <span class="text-2xl">ðŸ“Š</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Score MÃ©dio</p>
                        <p class="text-2xl font-bold text-gray-900" id="score-medio">0/6</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-primary-100 rounded-lg">
                        <span class="text-2xl">ðŸ“ˆ</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Taxa de QualificaÃ§Ã£o</p>
                        <p class="text-2xl font-bold text-gray-900" id="taxa-qualificacao">0%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GrÃ¡ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">DistribuiÃ§Ã£o por NÃ­vel</h3>
                <canvas id="pieChart" width="400" height="300"></canvas>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Score por Lead</h3>
                <canvas id="barChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Filtros e Busca</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        NÃ­vel de QualificaÃ§Ã£o
                    </label>
                    <select id="filtro-nivel" onchange="aplicarFiltros()" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="Todos">Todos</option>
                        <option value="Alto">Alto</option>
                        <option value="MÃ©dio">MÃ©dio</option>
                        <option value="Baixo">Baixo</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Score MÃ­nimo
                    </label>
                    <input type="range" id="filtro-score" min="0" max="6" value="0" onchange="aplicarFiltros()" class="w-full">
                    <div class="text-sm text-gray-500 mt-1" id="score-valor">0/6</div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Fonte
                    </label>
                    <select id="filtro-fonte" onchange="aplicarFiltros()" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="Todas">Todas</option>
                        <option value="Google Places">Google Places</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Receita Federal">Receita Federal</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Buscar por Nome
                    </label>
                    <input type="text" id="filtro-nome" placeholder="Digite o nome..." onkeyup="aplicarFiltros()" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
            </div>
        </div>

        <!-- Tabela de Leads -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">
                        Lista de Leads (<span id="leads-encontrados">0</span> encontrados)
                    </h3>
                    <button onclick="exportarCSV()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                        <span class="mr-2">ðŸ“¥</span>
                        Exportar CSV
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NÃ­vel</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fonte</th>
                        </tr>
                    </thead>
                    <tbody id="leads-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Leads serÃ£o inseridos aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Dados reais carregados do sistema
        let leads = [];
        let filteredLeads = [];
        let pieChart, barChart;

        // InicializaÃ§Ã£o
        document.addEventListener('DOMContentLoaded', function() {
            atualizarScoreValor();
            loadRealData(); // Carrega dados reais automaticamente
        });

        async function loadRealData() {
            try {
                updateDataStatus('Carregando dados reais...', 'loading');
                
                // Lista de arquivos de leads para tentar carregar (do mais recente para o mais antigo)
                const leadFiles = [
                    '../leads_coletados_20250903_213934.json',  // Mais recente
                    '../leads_coletados_20250903_200444.json',
                    '../leads_coletados_20250903_193153.json',
                    '../leads_coletados_20250903_171709.json'
                ];
                
                let leadsLoaded = false;
                
                for (const filename of leadFiles) {
                    try {
                        const response = await fetch(filename);
                        if (response.ok) {
                            leads = await response.json();
                            updateDataStatus(`Dados carregados: ${leads.length} leads de ${filename}`, 'success');
                            document.getElementById('last-update').textContent = `Ãšltima atualizaÃ§Ã£o: ${new Date().toLocaleString('pt-BR')}`;
                            leadsLoaded = true;
                            break;
                        }
                    } catch (fileError) {
                        console.log(`Arquivo ${filename} nÃ£o encontrado, tentando prÃ³ximo...`);
                        continue;
                    }
                }
                
                if (!leadsLoaded) {
                    // Se nÃ£o conseguir carregar nenhum arquivo, usa dados de exemplo
                    leads = getSampleData();
                    updateDataStatus('Usando dados de exemplo (nenhum arquivo de leads encontrado)', 'warning');
                }
                
                filteredLeads = [...leads];
                atualizarDashboard();
                criarGraficos();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                leads = getSampleData();
                filteredLeads = [...leads];
                updateDataStatus('Erro ao carregar dados. Usando dados de exemplo.', 'error');
                atualizarDashboard();
                criarGraficos();
            }
        }

        function updateDataStatus(message, type) {
            const statusElement = document.getElementById('data-status');
            const statusDot = statusElement.previousElementSibling;
            
            statusElement.textContent = message;
            
            // Remove classes anteriores
            statusDot.className = 'w-3 h-3 rounded-full mr-2';
            
            // Adiciona classe baseada no tipo
            switch(type) {
                case 'success':
                    statusDot.classList.add('bg-green-400');
                    break;
                case 'warning':
                    statusDot.classList.add('bg-yellow-400');
                    break;
                case 'error':
                    statusDot.classList.add('bg-red-400');
                    break;
                case 'loading':
                    statusDot.classList.add('bg-blue-400');
                    break;
            }
        }

        function getSampleData() {
            return [
                {
                nome: 'Supermercado Exemplo Ltda',
                telefone: '(11) 99999-9999',
                website: 'https://www.exemplo.com.br',
                endereco: 'Rua das Flores, 123, Centro, SÃ£o Paulo, SP',
                cnae: '4721-1/01',
                score: 5,
                qualificado: true,
                nivel_qualificacao: 'Alto',
                criterios_atingidos: ['Telefone vÃ¡lido', 'CNAE compatÃ­vel', 'EndereÃ§o vÃ¡lido', 'Nome vÃ¡lido'],
                fonte: 'Google Places',
                data_coleta: '03/09/2025 16:30:00'
            },
            {
                nome: 'Padaria do JoÃ£o',
                telefone: '(11) 88888-8888',
                website: '',
                endereco: 'Av. Paulista, 456, Bela Vista, SÃ£o Paulo, SP',
                cnae: '4722-0/00',
                score: 5,
                qualificado: true,
                nivel_qualificacao: 'Alto',
                criterios_atingidos: ['Telefone vÃ¡lido', 'CNAE compatÃ­vel', 'EndereÃ§o vÃ¡lido', 'Nome vÃ¡lido'],
                fonte: 'Google Places',
                data_coleta: '03/09/2025 16:30:00'
            },
            {
                nome: 'Academia Fitness',
                telefone: '(11) 77777-7777',
                website: 'https://academiafitness.com.br',
                endereco: 'Rua Augusta, 789, ConsolaÃ§Ã£o, SÃ£o Paulo, SP',
                cnae: '9311-5/01',
                score: 6,
                qualificado: true,
                nivel_qualificacao: 'Alto',
                criterios_atingidos: ['Telefone vÃ¡lido', 'CNAE compatÃ­vel', 'MÃ­dia social', 'EndereÃ§o vÃ¡lido', 'Nome vÃ¡lido'],
                fonte: 'Instagram',
                data_coleta: '03/09/2025 16:30:00'
            }
        ];
        }

        function atualizarDashboard() {
            const stats = {
                total: leads.length,
                qualificados: leads.filter(l => l.qualificado).length,
                scoreMedio: leads.length > 0 ? (leads.reduce((sum, l) => sum + (l.score || 0), 0) / leads.length).toFixed(1) : '0',
                taxaQualificacao: leads.length > 0 ? ((leads.filter(l => l.qualificado).length / leads.length) * 100).toFixed(1) : '0'
            };

            document.getElementById('total-leads').textContent = stats.total;
            document.getElementById('leads-qualificados').textContent = stats.qualificados;
            document.getElementById('score-medio').textContent = stats.scoreMedio + '/6';
            document.getElementById('taxa-qualificacao').textContent = stats.taxaQualificacao + '%';

            atualizarTabela();
            atualizarGraficos();
        }

        function aplicarFiltros() {
            const nivel = document.getElementById('filtro-nivel').value;
            const scoreMin = parseInt(document.getElementById('filtro-score').value);
            const fonte = document.getElementById('filtro-fonte').value;
            const nome = document.getElementById('filtro-nome').value.toLowerCase();

            filteredLeads = leads.filter(lead => {
                if (nivel !== 'Todos' && lead.nivel_qualificacao !== nivel) return false;
                if ((lead.score || 0) < scoreMin) return false;
                if (fonte !== 'Todas' && lead.fonte !== fonte) return false;
                if (nome && !lead.nome.toLowerCase().includes(nome)) return false;
                return true;
            });

            document.getElementById('leads-encontrados').textContent = filteredLeads.length;
            atualizarTabela();
        }

        function atualizarTabela() {
            const tbody = document.getElementById('leads-tbody');
            tbody.innerHTML = '';

            filteredLeads.forEach(lead => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${lead.nome || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${lead.endereco || 'EndereÃ§o nÃ£o informado'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lead.telefone || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${lead.website ? 
                            `<a href="${lead.website}" target="_blank" class="text-primary-600 hover:text-primary-900 text-sm">Visitar</a>` : 
                            '<span class="text-gray-400 text-sm">-</span>'
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            (lead.score || 0) >= 5 ? 'bg-success-100 text-success-800' :
                            (lead.score || 0) >= 3 ? 'bg-warning-100 text-warning-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${lead.score || 0}/6
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            (lead.nivel_qualificacao || 'Baixo') === 'Alto' ? 'bg-success-100 text-success-800' :
                            (lead.nivel_qualificacao || 'Baixo') === 'MÃ©dio' ? 'bg-warning-100 text-warning-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${lead.nivel_qualificacao || 'Baixo'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lead.fonte || 'N/A'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function criarGraficos() {
            // GrÃ¡fico de Pizza
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Alto', 'MÃ©dio', 'Baixo'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // GrÃ¡fico de Barras
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Score',
                        data: [],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 6
                        }
                    }
                }
            });
        }

        function atualizarGraficos() {
            const nivelData = [
                leads.filter(l => l.nivel_qualificacao === 'Alto').length,
                leads.filter(l => l.nivel_qualificacao === 'MÃ©dio').length,
                leads.filter(l => l.nivel_qualificacao === 'Baixo').length
            ];

            const scoreData = leads.slice(0, 10).map(lead => ({ name: lead.nome || 'N/A', score: lead.score || 0 }));

            // Atualizar grÃ¡fico de pizza
            pieChart.data.datasets[0].data = nivelData;
            pieChart.update();

            // Atualizar grÃ¡fico de barras
            barChart.data.labels = scoreData.map(d => d.name);
            barChart.data.datasets[0].data = scoreData.map(d => d.score);
            barChart.update();
        }

        function atualizarScoreValor() {
            const scoreInput = document.getElementById('filtro-score');
            const scoreValor = document.getElementById('score-valor');
            scoreInput.addEventListener('input', function() {
                scoreValor.textContent = this.value + '/6';
            });
        }

        function refreshData() {
            // ForÃ§a recarregamento dos dados
            updateDataStatus('Atualizando dados...', 'loading');
            loadRealData();
        }

        function exportarCSV() {
            const headers = ['Nome', 'Telefone', 'Website', 'EndereÃ§o', 'Score', 'NÃ­vel', 'Qualificado', 'Fonte', 'Data'];
            const csvContent = [
                headers.join(','),
                ...filteredLeads.map(lead => [
                    lead.nome || 'N/A',
                    lead.telefone || 'N/A',
                    lead.website || '',
                    lead.endereco || 'N/A',
                    lead.score || 0,
                    lead.nivel_qualificacao || 'Baixo',
                    lead.qualificado ? 'Sim' : 'NÃ£o',
                    lead.fonte || 'N/A',
                    lead.data_coleta || 'N/A'
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `leads_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>
